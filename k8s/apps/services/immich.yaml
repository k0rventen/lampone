apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
spec:
  interval: 10m
  chart:
    spec:
      chart: appchart
      version: "1.5.0"
      sourceRef:
        kind: HelmRepository
        name: appchart
        namespace: flux-system
      interval: 10m
  values:
    apps:
    - name: immich-server
      image: ghcr.io/immich-app/immich-server:v2.2.3@sha256:4504d794123c3f5410cc45bbc61e4d7dbcacec1e1b0cd2e599691430c94e5849
      service: 2283
      containerSpec:
        envFrom:
          - secretRef:
              name: immich-config
      podSpec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - immich-machine-learning
              topologyKey: "kubernetes.io/hostname"
      ingress:
        domain: immich.cocointhe.cloud
      volumeMounts:
        - name: server-data
          mountPath: /data
      volumes:
        - name: server-data
          persistentVolumeClaim:
            claimName: immich-server-data
      pvc:
        - immich-server-data


    - name: immich-machine-learning
      image: ghcr.io/immich-app/immich-machine-learning:v2.2.3@sha256:bf339cbb44af6c2ef25d9128e1da51b2bec0cfd524846a83e3017c21bd71ddb4
      service: 3003
      env:
      - name: TRANSFORMERS_CACHE
        value: /cache
      podSpec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - immich-server
              topologyKey: "kubernetes.io/hostname"
      containerSpec:
        envFrom:
          - secretRef:
              name: immich-config
      volumeMounts:
        - name: ml-cache
          mountPath: /cache
      volumes:
        - name: ml-cache
          persistentVolumeClaim:
            claimName: immich-ml-cache
      pvc:
        - immich-ml-cache


    - name: immich-valkey
      image: docker.io/valkey/valkey:9.0@sha256:4503e204c900a00ad393bec83c8c7c4c76b0529cd629e23b34b52011aefd1d27
      service: 6379


    - name: immich-postgres
      image: ghcr.io/immich-app/postgres:16-vectorchord0.4.3-pgvectors0.2.0@sha256:1a078b237c1d9b420b0ee59147386b4aa60d3a07a8e6a402fc84a57e41b043a4
      deploymentSpec:
        strategy:
          type: Recreate
      service: 5432
      env:
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_PASSWORD
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_USERNAME
      - name: POSTGRES_DB
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_DATABASE_NAME
      - name: POSTGRES_INITDB_ARGS
        value: '--data-checksums'

      volumeMounts:
        - name: pg-data
          mountPath: /var/lib/postgresql/data
      volumes:
        - name: pg-data
          persistentVolumeClaim:
            claimName: immich-pg-data
      pvc:
        - immich-pg-data
