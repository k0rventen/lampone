apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
spec:
  interval: 10m
  chart:
    spec:
      chart: appchart
      version: "1.5.0"
      sourceRef:
        kind: HelmRepository
        name: appchart
        namespace: flux-system
      interval: 10m
  values:
    apps:
    - name: immich-server
      image: ghcr.io/immich-app/immich-server:v2.2.1@sha256:2c951a4063b55ec2de197fdf6a85e32b05872d3a18a18eaf851b827ff2622814
      service: 2283
      containerSpec:
        envFrom:
          - secretRef:
              name: immich-config
      podSpec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - immich-machine-learning
              topologyKey: "kubernetes.io/hostname"
      ingress:
        domain: immich.cocointhe.cloud
      volumeMounts:
        - name: server-data
          mountPath: /data
      volumes:
        - name: server-data
          persistentVolumeClaim:
            claimName: immich-server-data
      pvc:
        - immich-server-data


    - name: immich-machine-learning
      image: ghcr.io/immich-app/immich-machine-learning:v2.2.1@sha256:590a76bba3d88ccf78b03cde0c0fb8788f7d76ae6caf90ad33a34b5b4cc35f11
      service: 3003
      env:
      - name: TRANSFORMERS_CACHE
        value: /cache
      podSpec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - immich-server
              topologyKey: "kubernetes.io/hostname"
      containerSpec:
        envFrom:
          - secretRef:
              name: immich-config
      volumeMounts:
        - name: ml-cache
          mountPath: /cache
      volumes:
        - name: ml-cache
          persistentVolumeClaim:
            claimName: immich-ml-cache
      pvc:
        - immich-ml-cache


    - name: immich-valkey
      image: docker.io/valkey/valkey:9.0@sha256:4503e204c900a00ad393bec83c8c7c4c76b0529cd629e23b34b52011aefd1d27
      service: 6379


    - name: immich-postgres
      image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:41eacbe83eca995561fe43814fd4891e16e39632806253848efaf04d3c8a8b84
      deploymentSpec:
        strategy:
          type: Recreate
      service: 5432
      env:
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_PASSWORD
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_USERNAME
      - name: POSTGRES_DB
        valueFrom:
          secretKeyRef:
            name: immich-config
            key: DB_DATABASE_NAME
      - name: POSTGRES_INITDB_ARGS
        value: '--data-checksums'

      volumeMounts:
        - name: pg-data
          mountPath: /var/lib/postgresql/data
      volumes:
        - name: pg-data
          persistentVolumeClaim:
            claimName: immich-pg-data
      pvc:
        - immich-pg-data
