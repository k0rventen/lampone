apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kromgo
  namespace: flux-system
spec:
  install:
    createNamespace: true
  interval: 24h
  chart:
    spec:
      chart: ./k8s/apps/appchart
      version: "x.x.x"
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      interval: 1h
  targetNamespace: cloud
  values:
    apps:
      - name: kromgo
        image: ghcr.io/kashalls/kromgo:v0.5.0@sha256:2ab429f5276e1cd2b306701588a7b5cdbf968c5a4298058a29a4d1e37ed9b97c
        service: 8080
        env:
          - name: PROMETHEUS_URL
            value: http://watchtower-prometheus-server.watchtower.svc.cluster.local
        volumeMounts:
          - name: kromgo-config
            mountPath: /kromgo/config.yaml
            subPath: config.yaml
        volumes:
          - name: kromgo-config
            configMap:
              name: kromgo-config

    configmaps:
      kromgo-config:
        config.yaml: |
          ---
          # yaml-language-server: $schema=https://raw.githubusercontent.com/kashalls/kromgo/main/config.schema.json
          badge:
            font: Verdana.ttf
            size: 12

          metrics:
            - name: kubernetes_version
              query: label_replace(kubernetes_build_info{instance="drupelet-1"}, "git_version", "$1", "git_version", "(.+)")
              label: git_version
              title: k8s version

            - name: cluster_temperature
              title: Temperature
              query: round(avg(node_hwmon_temp_celsius{}))
              suffix: "Â°C"
              colors:
                - { color: "green", min: 0, max: 55 }
                - { color: "orange", min: 56, max: 65 }
                - { color: "red", min: 66, max: 99 }

            - name: cluster_cpu_usage
              title: CPU Usage
              query: round(avg(100 * avg(1 - rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)))
              suffix: "%"
              colors:
                - { color: "green", min: 0, max: 35 }
                - { color: "orange", min: 36, max: 75 }
                - { color: "red", min: 76, max: 9999 }

            - name: cluster_memory_usage
              title: RAM Usage
              query: round(sum(node_memory_MemTotal_bytes{} - node_memory_MemAvailable_bytes{}) / sum(node_memory_MemTotal_bytes{}) * 100)
              suffix: "%"
              colors:
                - { color: green, min: 0, max: 35 }
                - { color: orange, min: 36, max: 75 }
                - { color: red, min: 76, max: 9999 }

            - name: cluster_uptime_days
              title: Uptime
              query: round(avg(node_time_seconds{} - node_boot_time_seconds{}) / 86400)
              suffix: "d"
              colors:
                - { color: "green", min: 0, max: 180 }
                - { color: "orange", min: 181, max: 360 }
                - { color: "red", min: 361, max: 9999 }
