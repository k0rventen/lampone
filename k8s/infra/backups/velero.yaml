apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: vmware-tanzu
spec:
  interval: 1h
  url: https://vmware-tanzu.github.io/helm-charts

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: velero
spec:
  interval: 10m
  chart:
    spec:
      chart: velero
      version: 11.0.0
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu
  values:
    initContainers:
    - name: velero-plugin-for-aws
      image: velero/velero-plugin-for-aws:v1.13.0
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins
    configuration:
      defaultVolumesToFsBackup: true
      backupStorageLocation:
        - name: default
          provider: aws
          bucket: velero
          config:
            region: garage
            s3ForcePathStyle: "true"
            s3Url: "https://garage.cocointhe.cloud"
    credentials:
      existingSecret: garage-velero-auth
      useSecret: true
    snapshotsEnabled: false
    deployNodeAgent: true
    # values for CSI 
    #   features: EnableCSI
    #   volumeSnapshotLocation:
    #   - provider: aws
    #     config:
    #       region: garage
    # snapshotsEnabled: true
