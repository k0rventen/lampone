name: Flux Local

on:
  pull_request:
    branches: ["main"]
jobs:
  test:
    name: flux test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run flux-local test
        uses: docker://ghcr.io/allenporter/flux-local:v7.3.0
        with:
          args: test --enable-helm --all-namespaces --path k8s/flux -v
  diff:
    name: flux diff
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          path: pr
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: "${{ github.event.repository.default_branch }}"
          path: main

      - name: Run flux-local diff
        uses: docker://ghcr.io/allenporter/flux-local:v7.3.0
        with:
          args: |
            diff ks
            --path pr/k8s/flux
            --path-orig main/k8s/flux
            --all-namespaces
